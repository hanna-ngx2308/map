<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Subway Sandwich 매장 지도 · Seoul</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body{height:100%;margin:0}
    #map{height:100vh;width:100%}
    .leaflet-popup-content{font-size:14px;line-height:1.5}
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Khởi tạo bản đồ
    const map=L.map('map').setView([37.5665,126.9780],12);

    // Nền xám sáng (Carto Light)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Icon Subway màu xanh
    const SubwayIcon=L.DivIcon.extend({options:{className:'',iconSize:[30,30],iconAnchor:[15,15],popupAnchor:[0,-14]}});
    const iconHtml = `<div style="width:30px;height:30px;border-radius:50%;background:#008938;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.2)">S</div>`;

    // Đọc dữ liệu subway_seoul.json
    fetch('subway_seoul.json',{cache:'no-store'})
      .then(r=>r.json())
      .then(rows=>{
        const bounds=[];
        rows.forEach(s=>{
          if(!isFinite(s.lat)||!isFinite(s.lng)) return;
          const m=L.marker([+s.lat,+s.lng],{icon:new SubwayIcon({html:iconHtml})})
            .bindPopup(`<b>${escapeHTML(s.name||'Subway')}</b><br>${escapeHTML(s.address||'')}${s.gu?('<br>'+escapeHTML(s.gu)):""}`)
            .addTo(map);
          bounds.push([+s.lat,+s.lng]);
        });
        if(bounds.length) map.fitBounds(bounds,{padding:[30,30]});
      })
      .catch(err=>{
        console.error(err);
        alert('Không đọc được subway_seoul.json. Hãy chạy crawler để tạo file.');
      });

    // Hàm escape text an toàn
    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
