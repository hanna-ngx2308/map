<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subway Sandwich ë§¤ì¥ ì§€ë„ Â· Seoul</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- MarkerCluster (nhÆ° subway mobile sáº½ gom Ä‘iá»ƒm Ä‘Ã´ng) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    :root{
      --brand:#008938; /* Subway green */
      --brand-2:#ffcc00; /* Subway yellow */
      --bg:#f7f7f8; --card:#fff; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .app{display:grid;grid-template-columns:360px 1fr;height:100vh}
    @media (max-width: 960px){ .app{grid-template-columns:1fr;height:auto} }
    header{
      grid-column:1/-1; display:flex; gap:10px; align-items:center;
      padding:10px 12px; background:#fff; border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:30;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand)}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .grow{flex:1}
    .controls{display:flex; gap:8px; width:100%}
    .input, select{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; background:#fff; font-size:14px;
    }
    button{
      border:none; background:var(--brand); color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    button.secondary{background:#111}
    button.link{background:transparent;color:var(--brand);padding:8px 10px}
    .layout{display:grid;grid-template-columns:360px 1fr; height:calc(100vh - 58px)}
    @media (max-width: 960px){
      .layout{grid-template-columns:1fr; height:auto}
    }
    aside{
      background:#fff; border-right:1px solid var(--border); overflow:auto;
    }
    .panel-head{
      padding:10px 12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border);
    }
    .count{font-weight:700}
    .list{padding:8px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:8px 0;
      display:grid; gap:6px; cursor:pointer; transition: box-shadow .15s ease;
    }
    .card:hover{box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .title{font-weight:800}
    .addr{color:var(--muted); font-size:13px}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{font-size:11px; background:#f1f5f9; border:1px solid var(--border); padding:3px 8px; border-radius:999px}
    .active{outline:2px solid var(--brand-2)}
    #map{height:100%; width:100%}
    @media (max-width: 960px){
      aside{order:2;max-height:48vh}
      #map{order:1; height:50vh}
      .layout{display:flex; flex-direction:column}
    }
    .floating{
      position:absolute; left:12px; top:72px; z-index:400; background:rgba(255,255,255,.9);
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      box-shadow:0 2px 10px rgba(0,0,0,.08); display:flex; gap:6px; align-items:center;
    }
    .legend{position:absolute; right:12px; bottom:12px; z-index:400; background:rgba(255,255,255,.95); padding:8px 10px; border-radius:10px; border:1px solid var(--border); font-size:12px}
    .legend b{color:#111}
    .leaflet-popup-content{font-size:14px; line-height:1.5}
    .cluster-custom{background:var(--brand); color:#fff; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.15); font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> Subway Sandwich Â· Seoul</div>
    <div class="grow controls">
      <input id="q" class="input" placeholder="ê²€ìƒ‰ / Search cá»­a hÃ ng, Ä‘á»‹a chá»‰â€¦" />
      <select id="gu" title="District">
        <option value="">ëª¨ë“  êµ¬ (All)</option>
        <!-- Báº¡n cÃ³ thá»ƒ rÃºt gá»n/Ä‘iá»u chá»‰nh danh sÃ¡ch quáº­n -->
        <option>ê°•ë‚¨êµ¬</option><option>ê°•ë™êµ¬</option><option>ê°•ë¶êµ¬</option><option>ê°•ì„œêµ¬</option>
        <option>ê´€ì•…êµ¬</option><option>ê´‘ì§„êµ¬</option><option>êµ¬ë¡œêµ¬</option><option>ê¸ˆì²œêµ¬</option>
        <option>ë…¸ì›êµ¬</option><option>ë„ë´‰êµ¬</option><option>ë™ëŒ€ë¬¸êµ¬</option><option>ë™ì‘êµ¬</option>
        <option>ë§ˆí¬êµ¬</option><option>ì„œëŒ€ë¬¸êµ¬</option><option>ì„œì´ˆêµ¬</option><option>ì„±ë™êµ¬</option>
        <option>ì„±ë¶êµ¬</option><option>ì†¡íŒŒêµ¬</option><option>ì–‘ì²œêµ¬</option><option>ì˜ë“±í¬êµ¬</option>
        <option>ìš©ì‚°êµ¬</option><option>ì€í‰êµ¬</option><option>ì¢…ë¡œêµ¬</option><option>ì¤‘êµ¬</option><option>ì¤‘ë‘êµ¬</option>
      </select>
      <button id="btnSearch">TÃ¬m</button>
    </div>
    <button id="toggleList" class="link" aria-label="Toggle list on mobile">Danh sÃ¡ch â¬‡</button>
  </header>

  <div class="layout">
    <aside id="side">
      <div class="panel-head">
        <div class="count"><span id="resultCount">0</span> káº¿t quáº£</div>
        <button id="btnReset" class="secondary">Reset</button>
      </div>
      <div class="list" id="list"></div>
    </aside>

    <div style="position:relative">
      <div class="floating">
        <button id="btnLocate" title="Äá»‹nh vá»‹ gáº§n tÃ´i">ğŸ“ Gáº§n tÃ´i</button>
        <button id="btnFit" title="Fit táº¥t cáº£ káº¿t quáº£">ğŸ—ºï¸ Fit</button>
      </div>
      <div id="map"></div>
      <div class="legend"><b>Gá»£i Ã½:</b> Nháº­p â€œGangnamâ€ hay â€œê°•ë‚¨êµ¬â€ Ä‘á»ƒ lá»c theo quáº­n; click card Ä‘á»ƒ nháº£y tá»›i marker.</div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // ====== 1) Dá»® LIá»†U: Æ°u tiÃªn fetch subway_seoul.json, fallback data máº«u ======
    const fallbackData = [
      {"name":"Subway Hongdae","address":"486 Seogyo-dong, Mapo-gu, Seoul","lat":37.557192,"lng":126.925381,"gu":"ë§ˆí¬êµ¬"},
      {"name":"Subway Toegye-ro","address":"204 Toegye-ro, Jung-gu, Seoul","lat":37.5630,"lng":126.9865,"gu":"ì¤‘êµ¬"},
      {"name":"Subway Gangnam Station","address":"Gangnam-daero, Seocho-gu, Seoul","lat":37.497175,"lng":127.027926,"gu":"ì„œì´ˆêµ¬"},
      {"name":"Subway Yeouido","address":"Yeouido-dong, Yeongdeungpo-gu, Seoul","lat":37.521624,"lng":126.924191,"gu":"ì˜ë“±í¬êµ¬"},
      {"name":"Subway Jamsil","address":"Songpa-gu, Seoul","lat":37.51395,"lng":127.102234,"gu":"ì†¡íŒŒêµ¬"}
    ];

    async function loadData(){
      try{
        const res = await fetch('subway_seoul.json', { cache:'no-store' });
        if(!res.ok) throw new Error('no file');
        const data = await res.json();
        // Chuáº©n hoÃ¡: yÃªu cáº§u cÃ³ name, address, lat, lng, (tuá»³ chá»n) gu
        return data.map(d => ({
          name: d.name, address: d.address, lat: +d.lat, lng: +d.lng,
          gu: d.gu || guessGu(d.address)
        })).filter(d => isFinite(d.lat) && isFinite(d.lng));
      }catch(e){
        return fallbackData;
      }
    }

    function guessGu(addr=""){
      // ÄoÃ¡n quáº­n tá»« chuá»—i Ä‘á»‹a chá»‰ (ráº¥t Ä‘Æ¡n giáº£n; báº¡n cÃ³ thá»ƒ thay báº±ng mapping chuáº©n)
      const gus = ["ê°•ë‚¨êµ¬","ê°•ë™êµ¬","ê°•ë¶êµ¬","ê°•ì„œêµ¬","ê´€ì•…êµ¬","ê´‘ì§„êµ¬","êµ¬ë¡œêµ¬","ê¸ˆì²œêµ¬","ë…¸ì›êµ¬","ë„ë´‰êµ¬","ë™ëŒ€ë¬¸êµ¬","ë™ì‘êµ¬","ë§ˆí¬êµ¬","ì„œëŒ€ë¬¸êµ¬","ì„œì´ˆêµ¬","ì„±ë™êµ¬","ì„±ë¶êµ¬","ì†¡íŒŒêµ¬","ì–‘ì²œêµ¬","ì˜ë“±í¬êµ¬","ìš©ì‚°êµ¬","ì€í‰êµ¬","ì¢…ë¡œêµ¬","ì¤‘êµ¬","ì¤‘ë‘êµ¬"];
      const found = gus.find(g => addr.includes(g));
      return found || "";
    }

    // ====== 2) MAP ======
    const map = L.map('map', { zoomControl:true }).setView([37.5665,126.9780], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Icon logo (dÃ¹ng divIcon cho nhanh; náº¿u cÃ³ file logo, Ä‘á»•i thÃ nh L.icon)
    const LogoIcon = L.DivIcon.extend({
      options:{
        className:'', iconSize:[36,36], iconAnchor:[18,18], popupAnchor:[0,-16]
      }
    });
    function makeLogoIcon(){
      // mÃ u ná»n xanh Subway + chá»¯ S Ä‘Æ¡n giáº£n (cÃ³ thá»ƒ thay báº±ng <img src="subway_logo.svg">)
      const html = `
        <div style="width:36px;height:36px;border-radius:50%;
          background:var(--brand);display:flex;align-items:center;justify-content:center;
          color:#fff;font-weight:900;border:2px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.2)">
          S
        </div>`;
      return new LogoIcon({ html });
    }

    // Cluster
    const cluster = L.markerClusterGroup({
      iconCreateFunction: cluster => {
        return L.divIcon({
          html:`<div class="cluster-custom">${cluster.getChildCount()}</div>`,
          className:'', iconSize:[36,36]
        });
      }
    });
    map.addLayer(cluster);

    // ====== 3) STATE & RENDER ======
    let RAW = [];        // toÃ n bá»™ Ä‘iá»ƒm
    let markers = [];    // máº£ng marker Ä‘ang hiá»ƒn thá»‹

    const els = {
      q: document.getElementById('q'),
      gu: document.getElementById('gu'),
      btnSearch: document.getElementById('btnSearch'),
      btnReset: document.getElementById('btnReset'),
      list: document.getElementById('list'),
      count: document.getElementById('resultCount'),
      btnLocate: document.getElementById('btnLocate'),
      btnFit: document.getElementById('btnFit'),
      toggleList: document.getElementById('toggleList'),
      side: document.getElementById('side')
    };

    function filterData(){
      const q = els.q.value.trim().toLowerCase();
      const gu = els.gu.value.trim();
      return RAW.filter(d => {
        const hitQ = !q || d.name.toLowerCase().includes(q) || d.address.toLowerCase().includes(q);
        const hitGu = !gu || d.gu === gu;
        return hitQ && hitGu;
      });
    }

    function clearMarkers(){
      markers.forEach(m => cluster.removeLayer(m));
      markers = [];
    }

    function renderList(rows){
      els.list.innerHTML = rows.map((d,i)=>`
        <div class="card" data-idx="${i}">
          <div class="title">${escapeHTML(d.name)}</div>
          <div class="addr">${escapeHTML(d.address)}</div>
          ${d.gu ? `<div class="tags"><span class="tag">${d.gu}</span></div>`:''}
        </div>
      `).join('');
      els.count.textContent = rows.length.toString();

      // click card â†’ fly to marker
      Array.from(els.list.querySelectorAll('.card')).forEach((card,i)=>{
        card.addEventListener('click',()=>{
          const m = markers[i];
          if(!m) return;
          map.flyTo(m.getLatLng(), 16, { duration:.6 });
          m.openPopup();
          highlightCard(i);
        });
      });
    }

    function renderMarkers(rows){
      clearMarkers();
      const bounds = [];
      rows.forEach((d,i)=>{
        const m = L.marker([d.lat,d.lng], { icon: makeLogoIcon() })
          .bindPopup(`<b>${escapeHTML(d.name)}</b><br>${escapeHTML(d.address)}`);
        m.on('click', ()=> highlightCard(i));
        cluster.addLayer(m);
        markers.push(m);
        bounds.push([d.lat,d.lng]);
      });
      if(bounds.length) map.fitBounds(bounds, { padding:[30,30] });
    }

    function highlightCard(i){
      Array.from(els.list.children).forEach((el,idx)=>{
        el.classList.toggle('active', idx===i);
        if(idx===i) el.scrollIntoView({block:'center', behavior:'smooth'});
      });
    }

    function escapeHTML(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function boot(){
      RAW = await loadData();
      const rows = filterData();
      renderList(rows);
      renderMarkers(rows);
    }

    // ====== 4) EVENTS ======
    els.btnSearch.addEventListener('click', ()=>{
      const rows = filterData(); renderList(rows); renderMarkers(rows);
    });
    els.btnReset.addEventListener('click', ()=>{
      els.q.value=''; els.gu.value=''; const rows = filterData(); renderList(rows); renderMarkers(rows);
    });
    els.q.addEventListener('keydown', (e)=>{ if(e.key==='Enter') els.btnSearch.click(); });
    els.gu.addEventListener('change', ()=> els.btnSearch.click());
    els.btnLocate.addEventListener('click', ()=>{
      navigator.geolocation?.getCurrentPosition(pos=>{
        const { latitude, longitude } = pos.coords;
        map.flyTo([latitude, longitude], 15, { duration:.6 });
        L.circle([latitude,longitude], {radius:200, color:'#2563eb'}).addTo(map);
      }, err=> alert('KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­. HÃ£y báº­t quyá»n Location.'));
    });
    els.btnFit.addEventListener('click', ()=> {
      if(!markers.length) return;
      const b = L.latLngBounds(markers.map(m=>m.getLatLng()));
      map.fitBounds(b, { padding:[30,30] });
    });
    els.toggleList.addEventListener('click', ()=>{
      els.side.style.display = (els.side.style.display==='none' ? '' : 'none');
    });

    // Start
    boot();
  </script>
</body>
</html>
